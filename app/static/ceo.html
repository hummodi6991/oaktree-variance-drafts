<!doctype html>
<html lang="en">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Oaktree Variance Drafts — CEO</title>
<style>
 body{font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;max-width:980px}
 h1{font-size:20px;margin:0 0 16px}
 .card{border:1px solid #e5e7eb;border-radius:10px;padding:16px;margin:12px 0}
 .row{display:flex;gap:12px;flex-wrap:wrap}
 textarea,pre{width:100%;min-height:160px;border:1px solid #e5e7eb;border-radius:8px;padding:10px;background:#fafafa}
 button{background:#2563eb;color:#fff;border:0;padding:10px 16px;border-radius:8px;cursor:pointer}
 button:disabled{opacity:.6;cursor:not-allowed}
 .progress-wrap{margin:12px 0;display:none}
 .progress{width:100%;background:#eee;border-radius:6px;overflow:hidden;height:12px}
 .bar{height:12px;width:0%}
  .status{margin-top:6px;opacity:.85}
  .muted{color:#64748b;font-size:13px}
</style>
<h1>Oaktree Variance Drafts</h1>
<div class="card">
  <p>Paste or upload JSON matching the API schema (BudgetActuals, ChangeOrders, VendorMap, CategoryMap, Config).</p>
  <div class="row">
    <textarea id="payload" placeholder='{"budget_actuals":[...], "change_orders":[...], "vendor_map":[...], "category_map":[...], "config":{...}}'></textarea>
  </div>
  <div class="progress-wrap" id="pwrap">
    <div class="progress"><div class="bar" id="pbar"></div></div>
    <div class="status" id="pmsg">Preparing…</div>
  </div>
  <div class="row">
    <button id="generateBtn">Generate</button>
    <span id="hint" class="status muted"></span>
  </div>
</div>
<div class="card">
  <h3>Result</h3>
  <pre id="resultArea">{}</pre>
</div>

<div class="card" style="margin-top:20px;">
  <h3>Single Data File</h3>
  <p>Upload a single procurement or report file. If both Budget and Actual are found, variances will be calculated; otherwise a procurement/general summary is produced.</p>
  <input id="single_file" type="file" accept=".csv,.xlsx,.xls,.docx,.pdf,.txt,.md,.rtf" />
  <div style="margin-top:10px;">
    <button onclick="onSingleProcess()">Process file</button>
  </div>
  <div id="single_result" style="margin-top:10px;"></div>
</div>
<script>
const ui = {
  btn: document.getElementById('generateBtn'),
  txt: document.getElementById('payload'),
  pwrap: document.getElementById('pwrap'),
  pbar: document.getElementById('pbar'),
  pmsg: document.getElementById('pmsg'),
  hint: document.getElementById('hint'),
  out: document.getElementById('resultArea')
};

async function postJSON(url, data, signal){
  const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data), signal});
  if(!res.ok) throw new Error(await res.text());
  return res.json();
}

async function poll(jobId){
  let done = false;
  while(!done){
    let r;
    try{
      const resp = await fetch(`/jobs/${jobId}`);
      if(!resp.ok) throw new Error(await resp.text());
      r = await resp.json();
    }catch(err){
      ui.pmsg.textContent = `Error: ${err.message || err}`;
      ui.btn.disabled = false;
      ui.hint.textContent = 'Tip: open /diag/openai and /health in a new tab to verify connectivity.';
      break;
    }
    ui.pwrap.style.display='block';
    ui.pbar.style.width = `${r.progress}%`;
    ui.pbar.style.background = `linear-gradient(90deg,#3b82f6, #10b981 ${r.progress}%)`;
    ui.pmsg.textContent = `${r.message || ''} ${r.progress}%`;
    if(r.status === 'done'){
      done = true;
      ui.pmsg.textContent = 'Completed 100%';
      ui.out.textContent = JSON.stringify(r.result, null, 2);
      ui.btn.disabled = false;
      break;
    }
    if(r.status === 'error'){
      done = true;
      ui.pmsg.textContent = `Error: ${r.message}`;
      ui.btn.disabled = false;
      break;
    }
    await new Promise(res=>setTimeout(res, 1000));
  }
}

ui.btn.onclick = async () => {
  try{
    const data = JSON.parse(ui.txt.value || "{}");
    ui.btn.disabled = true;
    ui.hint.textContent = '';
    ui.pwrap.style.display='block';
    ui.pbar.style.width='0%';
    ui.pbar.style.background='#3b82f6';
    ui.pmsg.textContent='Queued…';
    const controller = new AbortController();
    const t = setTimeout(()=>controller.abort(), 120000);
    const start = await postJSON('/drafts/async', data, controller.signal);
    clearTimeout(t);
    await poll(start.job_id);
  }catch(err){
    ui.pmsg.textContent = `Error: ${err.message || err}`;
    ui.hint.textContent = 'Tip: open /diag/openai and /health in a new tab to verify connectivity.';
    ui.btn.disabled = false;
  }
};

const esc = (s) => (s == null ? '' : String(s).replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])));

async function postSingleFile(url, file) {
  const fd = new FormData();
  fd.append('file', file);
  const res = await fetch(url, { method: 'POST', body: fd });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

function renderProcurementSummary(items, drafts) {
  const host = document.getElementById("single_result");
  if (!items || !items.length) {
    host.innerHTML = `<div class="warn">No extractable items found in the file.</div>`;
    return;
  }
  let html = `<h4>Procurement / General Summary</h4>`;
  for (let i=0;i<items.length;i++) {
    const it = items[i] || {};
    const d  = (drafts && drafts[i]) || {};
    html += `
      <div class="card" style="margin:10px 0;">
        <div style="font-weight:600;margin-bottom:4px;">Item ${i+1}</div>
        <div style="font-size:14px;opacity:.85">
          ${it.item_code ? `<div>Item code: ${esc(it.item_code)}</div>` : ``}
          ${it.description ? `<div>Description: ${esc(it.description)}</div>` : ``}
          ${it.qty != null ? `<div>Quantity: ${esc(it.qty)}</div>` : ``}
          ${it.unit_price_sar != null ? `<div>Unit price (SAR): ${esc(it.unit_price_sar)}</div>` : ``}
          ${it.amount_sar != null ? `<div>Line total (SAR): ${esc(it.amount_sar)}</div>` : ``}
          ${it.vendor ? `<div>Vendor: ${esc(it.vendor)}</div>` : ``}
          ${it.doc_date ? `<div>Document date: ${esc(it.doc_date)}</div>` : ``}
          <div>Evidence: Uploaded procurement file</div>
        </div>
        <div style="margin-top:8px;">
          <div><strong>Draft (EN):</strong> ${esc(d.en || "")}</div>
          <div><strong>المسودة (AR):</strong> ${esc(d.ar || "")}</div>
        </div>
      </div>
    `;
  }
  host.innerHTML = html;
}

function renderVarianceInsights(resp) {
  const host = document.getElementById("single_result");
  const v = resp.variances || [];
  const ins = resp.insights || {};
  let html = `<h4>Variance Insights</h4>
    <div class="card" style="margin:10px 0;padding:8px 10px;font-size:14px;">
      <div>Total Budget (SAR): <b>${esc(ins.total_budget)}</b></div>
      <div>Total Actual (SAR): <b>${esc(ins.total_actual)}</b></div>
      <div>Total Variance (SAR): <b>${esc(ins.total_variance)}</b></div>
    </div>
    <table style="width:100%;border-collapse:collapse;margin-top:6px;">
      <thead><tr>
        <th style="text-align:left">Project</th>
        <th style="text-align:left">Period</th>
        <th style="text-align:left">Cost Code</th>
        <th style="text-align:left">Description</th>
        <th style="text-align:right">Budget</th>
        <th style="text-align:right">Actual</th>
        <th style="text-align:right">Variance</th>
      </tr></thead><tbody>`;
  for (const r of v) {
    html += `<tr>
      <td>${esc(r.project_id||"")}</td>
      <td>${esc(r.period||"")}</td>
      <td>${esc(r.cost_code||"")}</td>
      <td>${esc(r.description||"")}</td>
      <td style="text-align:right">${esc(r.budget_sar)}</td>
      <td style="text-align:right">${esc(r.actual_sar)}</td>
      <td style="text-align:right">${esc(r.variance_sar)}</td>
    </tr>`;
  }
  html += `</tbody></table>`;

  const inc = (ins.top_increases||[]).slice(0,5);
  const dec = (ins.top_decreases||[]).slice(0,5);
  if (inc.length || dec.length) {
    html += `<div style="display:flex;gap:16px;margin-top:12px;flex-wrap:wrap;">
      <div class="card" style="flex:1;min-width:260px;"><h5>Top Increases</h5>${
        inc.map(x=>`<div>${esc(x.cost_code||x.description||"")} — <b>${esc(x.variance_sar)}</b></div>`).join("")||"<div>—</div>"}</div>
      <div class="card" style="flex:1;min-width:260px;"><h5>Top Decreases</h5>${
        dec.map(x=>`<div>${esc(x.cost_code||x.description||"")} — <b>${esc(x.variance_sar)}</b></div>`).join("")||"<div>—</div>"}</div>
    </div>`;
  }
  host.innerHTML = html;
}

async function onSingleProcess() {
  const input = document.getElementById("single_file");
  const host  = document.getElementById("single_result");
  if (!input.files || input.files.length === 0) {
    host.textContent = "Please choose a file.";
    return;
  }
  host.textContent = "Processing…";
  try {
    const res = await postSingleFile("/singlefile/report", input.files[0]);
    if (res.mode === "variance") {
      renderVarianceInsights(res);
    } else {
      renderProcurementSummary(res.items || [], res.drafts || []);
    }
  } catch (e) {
    host.textContent = "Failed to process file. Check server logs.";
    console.error(e);
  }
}
</script>
</html>
