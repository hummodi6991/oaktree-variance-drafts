<!doctype html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Oaktree Variance Drafts</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;margin:24px;line-height:1.45}
  textarea{width:100%;height:260px;font-family:ui-monospace,Menlo,Consolas,monospace}
  .bar{height:8px;background:#eee;border-radius:4px;margin:12px 0}
  .fill{height:8px;background:#2563eb;border-radius:4px;width:0%}
  pre{background:#0b0b0b;color:#e6e6e6;padding:16px;border-radius:8px;overflow:auto}
  button{padding:8px 14px;border-radius:8px;border:1px solid #d0d0d0;background:white;cursor:pointer}
  .tabs{display:flex;gap:8px;margin-bottom:14px}
  .tab{padding:8px 12px;border-radius:8px;border:1px solid #d0d0d0}
  .tab.active{background:#2563eb;color:white;border-color:#2563eb}
  .card{border:1px solid #e5e5e5;border-radius:12px;padding:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .muted{color:#666}
  label{display:block;margin-top:10px;margin-bottom:6px;font-weight:600}
  input[type="number"]{width:200px;padding:6px 8px;border:1px solid #ccc;border-radius:6px}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<h1>Oaktree Variance Drafts</h1>
<div class="tabs">
  <div id="tab-json" class="tab active">JSON mode</div>
  <div id="tab-csv" class="tab">CSV/XLSX mode</div>
</div>

<div id="pane-json" class="card">
  <p>Paste or upload JSON matching the API schema (BudgetActuals, ChangeOrders, VendorMap, CategoryMap, Config).</p>
  <textarea id="json"></textarea>
  <div style="margin-top:8px">
    <input type="file" id="jsonFile" accept=".json,application/json" />
    <button id="load">Load JSON</button>
    <button id="run">Generate</button>
  </div>
</div>

  <div id="pane-csv" class="card" style="display:none">
  <div class="grid">
    <div>
      <label>Budget–Actuals CSV/XLSX</label>
      <input type="file" id="budget_file" accept=".csv,.xls,.xlsx" />
    </div>
    <div>
      <label>Change Orders CSV/XLSX</label>
      <input type="file" id="co_file" accept=".csv,.xls,.xlsx" />
    </div>
    <div>
      <label>Vendor Map CSV/XLSX</label>
      <input type="file" id="vendor_file" accept=".csv,.xls,.xlsx" />
    </div>
    <div>
      <label>Category Map CSV/XLSX</label>
      <input type="file" id="category_file" accept=".csv,.xls,.xlsx" />
    </div>
  </div>
  <div style="margin-top:14px;display:flex;gap:20px;align-items:center;flex-wrap:wrap">
    <div><label>Materiality %</label><input id="mat_pct" type="number" value="5"></div>
    <div><label>Materiality amount (SAR)</label><input id="mat_amt" type="number" value="100000"></div>
    <label><input id="bilingual" type="checkbox" checked> Bilingual</label>
    <label><input id="no_spec" type="checkbox" checked> No speculation</label>
  </div>
  <div style="margin-top:10px">
    <button id="run_csv">Generate</button>
  </div>
  <p class="muted">Expected columns:
     <b>budget_actuals.csv/xlsx</b>: project_id, <strong>period</strong>, cost_code (or category), budget_sar, actual_sar ·
     <b>change_orders.csv/xlsx</b>: project_id, co_id, <strong>date</strong>, amount_sar, description, linked_cost_code, file_link ·
     <b>vendor_map.csv/xlsx</b>: project_id, cost_code, vendor_name, trade, contract_id ·
     <b>category_map.csv/xlsx</b>: cost_code, category.
  </p>
  <p class="muted">Tip: the uploader also accepts friendly headers <code>period(YYYY-MM)</code> and <code>date(YYYY-MM-DD)</code>; they'll be mapped automatically.</p>
</div>

<div class="card" style="margin-top:18px;">
  <h3>Free-form Source (CSV / Excel / Word / PDF / Text)</h3>
  <p>Use this when your data is incomplete or doesn’t match the standard templates. 
  The report below will be based solely on what exists in the file (no invention).</p>
  <input id="freeform_files" type="file" multiple 
         accept=".csv,.xlsx,.xls,.docx,.pdf,.txt,.md,.rtf" />
  <div style="margin-top:10px;">
    <button id="btn_freeform_preview">Pre-process free-form file(s)</button>
    <button id="btn_freeform_generate">Generate from free-form only</button>
  </div>
  <pre id="freeform_preview" class="codebox" style="display:none;"></pre>
</div>

<!-- Single Data File (CSV, Excel, Word, PDF, or Text) -->
<div class="group">
  <label class="lbl">Single Data File (CSV, Excel, Word, PDF, or Text)</label>
  <input id="single-file-input" type="file" accept=".csv,.xlsx,.xls,.docx,.pdf,.txt" />
  <label><input id="opt-bilingual" type="checkbox" checked /> Bilingual</label>
  <label><input id="opt-nospec" type="checkbox" checked /> No speculation</label>
  <!-- hook:single-file-generate-button -->
  <button class="btn" onclick="generateFromSingleFile()">Generate from file</button>
</div>

<div class="bar"><div class="fill" id="bar"></div></div>
<div id="msg" class="muted"></div>
<div id="err" style="color:#dc2626;font-size:0.9rem;margin-top:.25rem"></div>
<div id="warn" class="warn"></div>
<h3>Result</h3>
<pre id="out">{}</pre>

<script>
  const el = (id)=>document.getElementById(id);
  const show = (a)=>a.style.display='';
  const hide = (a)=>a.style.display='none';
  function setBar(p){ el('bar').style.width = p+'%'; }
  function setMsg(t){ el('msg').textContent = t; }
  function showError(t){ el('err').textContent = t; }
  function clearError(){ el('err').textContent = ''; el('warn').textContent = ''; }
  function showWarn(t){ el('warn').textContent = t; }

  // Tabs
  el('tab-json').onclick = ()=>{ el('tab-json').classList.add('active'); el('tab-csv').classList.remove('active'); show(el('pane-json')); hide(el('pane-csv')); };
  el('tab-csv').onclick  = ()=>{ el('tab-csv').classList.add('active');  el('tab-json').classList.remove('active');  show(el('pane-csv'));  hide(el('pane-json')); };

  // JSON mode
  el('load').onclick = async ()=>{
    const f = el('jsonFile').files[0]; if(!f) return;
    const txt = await f.text(); el('json').value = txt;
  };
  async function callDrafts(payload){
    const res = await fetch('/drafts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!res.ok){ const t=await res.text(); throw new Error('API '+res.status+': '+t); }
    return await res.json();
  }
  el('run').onclick = async ()=>{
    try{
      setMsg('Calling model (EN)'); setBar(75);
      const payload = JSON.parse(el('json').value || '{}');
      const data = await callDrafts(payload);
      setBar(100); setMsg('Done');
      el('out').textContent = JSON.stringify(data,null,2);
    }catch(e){ setMsg('Error: '+e.message); setBar(0); }
  };

  async function parseTableFile(file) {
    // Robust CSV/XLSX reader with tolerant header mapping
    // 1) Read file
    const buf = await file.arrayBuffer();
    const bytes = new Uint8Array(buf);

    // 2) Try Excel first if extension .xlsx
    const isXlsx = file.name.toLowerCase().endsWith('.xlsx');
    let rows = [];
    if (isXlsx) {
      if (!window.XLSX) { throw new Error('XLSX library missing'); }
      const wb = XLSX.read(bytes, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
    } else {
      // CSV path: auto-detect delimiter, handle BOM, trim headers
      rows = await new Promise((resolve, reject) => {
        Papa.parse(new Blob([bytes]), {
          header: true,
          skipEmptyLines: 'greedy',
          dynamicTyping: false,
          transformHeader: h => (h || '')
            .replace(/\uFEFF/g, '')          // strip BOM
            .trim()
            .toLowerCase()
            .replace(/\s+/g, ' ')
            .replace(/[^a-z0-9]+/g, '_'),     // normalize
          delimitersToGuess: [',',';','\t','|'],
          complete: r => resolve(r.data || []),
          error: err => reject(err)
        });
      });
    }

    // 3) Tolerant header mapping per table type decided later
    return rows;
  }

  function mapBudgetActuals(rows) {
    // Accept many header variants, map to required keys
    const mapKey = (k) => {
      const s = (k || '').toString().trim().toLowerCase();
      if (['project','project_id','project_name','projectid','project_code'].includes(s)) return 'project_id';
      if (['period','month','posting_period','fiscal_period'].includes(s)) return 'period';
      if (['cost_code','gl_code','costcode','account','account_code'].includes(s)) return 'cost_code';
      if (['category','reporting_category','dept','department'].includes(s)) return 'category';
      if (['budget_sar','budget','budget_(sar)','budget_amount','budget_value'].includes(s)) return 'budget_sar';
      if (['actual_sar','actual','actuals','actual_(sar)','actual_amount'].includes(s)) return 'actual_sar';
      return null;
    };
    return rows
      .map(r => {
        const out = {};
        Object.keys(r).forEach(k => {
          const t = mapKey(k);
          if (t) out[t] = (r[k] ?? '').toString().trim();
        });
        return out;
      })
      // keep rows that at least have project + (cost_code or category) + one of budget/actual
      .filter(r => r.project_id && (r.cost_code || r.category) && (r.budget_sar || r.actual_sar));
  }

  function mapChangeOrders(rows) {
    const mapKey = (k) => {
      const s = (k || '').toString().trim().toLowerCase();
      if (['project','project_id','project_name'].includes(s)) return 'project_id';
      if (['linked_cost_code','cost_code','gl_code','account','account_code'].includes(s)) return 'linked_cost_code';
      if (['co_id','change_order_id','co_number','change_order_no'].includes(s)) return 'co_id';
      if (['date','co_date','document_date','approved_on'].includes(s)) return 'date';
      if (['amount_sar','amount','value','value_(sar)'].includes(s)) return 'amount_sar';
      if (['description','memo','remarks'].includes(s)) return 'description';
      if (['file_link','evidence','link','url','document_url'].includes(s)) return 'file_link';
      return null;
    };
    return rows.map(r => {
      const out = {};
      Object.keys(r).forEach(k => { const t = mapKey(k); if (t) out[t] = (r[k] ?? '').toString().trim(); });
      return out;
    });
  }

  function mapVendorMap(rows) {
    const key = (k) => {
      const s = (k||'').toLowerCase();
      if (['project','project_id','project_name'].includes(s)) return 'project_id';
      if (['cost_code','gl_code','account','account_code'].includes(s)) return 'cost_code';
      if (['vendor_name','supplier','vendor','supplier_name'].includes(s)) return 'vendor_name';
      if (['trade','category','division'].includes(s)) return 'trade';
      if (['contract_id','po','po_number','contract','agreement_no'].includes(s)) return 'contract_id';
      return null;
    };
    return rows.map(r => {
      const out = {};
      Object.keys(r).forEach(k => { const t = key(k); if (t) out[t] = (r[k] ?? '').toString().trim(); });
      return out;
    }).filter(r => r.project_id && r.cost_code && r.vendor_name);
  }

  function mapCategoryMap(rows) {
    const key = (k) => {
      const s = (k||'').toLowerCase();
      if (['cost_code','gl_code','account','account_code'].includes(s)) return 'cost_code';
      if (['category','reporting_category','group'].includes(s)) return 'category';
      return null;
    };
    return rows.map(r => {
      const out = {};
      Object.keys(r).forEach(k => { const t = key(k); if (t) out[t] = (r[k] ?? '').toString().trim(); });
      return out;
    }).filter(r => r.cost_code && r.category);
  }

  async function buildPayloadFromFiles(files) {
    // parse
    const budgetRows = files.budget_actuals ? await parseTableFile(files.budget_actuals) : [];
    const changeRows = files.change_orders ? await parseTableFile(files.change_orders) : [];
    const vendorRows  = files.vendor_map ? await parseTableFile(files.vendor_map) : [];
    const categoryRows= files.category_map ? await parseTableFile(files.category_map) : [];

    // tolerant maps
    const payload = {
      budget_actuals: mapBudgetActuals(budgetRows),
      change_orders:  mapChangeOrders(changeRows),
      vendor_map:     mapVendorMap(vendorRows),
      category_map:   mapCategoryMap(categoryRows),
    };

    return payload;
  }

  async function onGenerateClicked() {
    // ... gather files as before
    const files = {
      budget_actuals: document.getElementById('budget_file').files[0] || null,
      change_orders:  document.getElementById('co_file').files[0] || null,
      vendor_map:     document.getElementById('vendor_file').files[0] || null,
      category_map:   document.getElementById('category_file').files[0] || null,
    };

    // NEW: only block when no Budget–Actuals file is physically selected
    if (!files.budget_actuals) {
      showError('Please provide at least a Budget–Actuals file.');
      return;
    }

    clearError();
    try{
      setMsg('Parsing files'); setBar(25);
      const payload = await buildPayloadFromFiles(files);
      payload.config = {
        materiality_pct: Number(el('mat_pct').value||5),
        materiality_amount_sar: Number(el('mat_amt').value||100000),
        bilingual: el('bilingual').checked,
        enforce_no_speculation: el('no_spec').checked,
      };
      // If parsing produced zero budget rows, explain why but still send to backend (it will validate again).
      if (!payload.budget_actuals.length) {
        showWarn('Could not recognize columns in Budget–Actuals. We will still send the file for server-side parsing.');
      }

      setMsg('Calling model (EN)'); setBar(75);
      const data = await callDrafts(payload);
      setBar(100); setMsg('Done');
      el('out').textContent = JSON.stringify(data,null,2);
    }catch(e){ setMsg('Error: '+e.message); setBar(0); }
  }

  el('run_csv').onclick = onGenerateClicked;

  async function postFiles(url, files) {
    const fd = new FormData();
    for (const f of files) fd.append('files', f);
    const r = await fetch(url, { method: 'POST', body: fd });
    if (!r.ok) { const t = await r.text(); throw new Error('API ' + r.status + ': ' + t); }
    return r.json();
  }

  window.__free_rows__ = [];
  window.__free_mode__ = 'change_orders';

  async function doFreeformPreview() {
    const inp = document.getElementById('freeform_files');
    const box = document.getElementById('freeform_preview');
    if (!inp.files.length) { box.style.display='block'; box.textContent='No files selected.'; return; }
    const out = await postFiles('/extract/freeform', inp.files);
    window.__free_rows__ = out.rows || [];
    window.__free_mode__ = out.mode || 'change_orders';
    box.style.display='block';
    box.textContent = JSON.stringify({mode: window.__free_mode__, rows: window.__free_rows__.slice(0,10), total: window.__free_rows__.length}, null, 2);
  }

  async function doFreeformGenerate() {
    clearError();
    const inp = document.getElementById('freeform_files');
    if (!window.__free_rows__.length && inp.files.length) {
      const out = await postFiles('/extract/freeform', inp.files);
      window.__free_rows__ = out.rows || [];
      window.__free_mode__ = out.mode || 'change_orders';
    }
    const cfg = {
      materiality_pct: Number(el('mat_pct').value || 5),
      materiality_amount_sar: Number(el('mat_amt').value || 100000),
      bilingual: el('bilingual').checked,
      enforce_no_speculation: el('no_spec').checked,
    };
    const payload = {
      budget_actuals: window.__free_mode__ === 'budget_actuals' ? window.__free_rows__ : [],
      change_orders: window.__free_mode__ === 'change_orders' ? window.__free_rows__ : [],
      vendor_map: [],
      category_map: [],
      config: cfg,
    };
    setMsg('Calling model (EN)'); setBar(75);
    const data = await callDrafts(payload);
    setBar(100); setMsg('Done');
    el('out').textContent = JSON.stringify(data, null, 2);
  }

  document.getElementById('btn_freeform_preview').addEventListener('click', async () => {
    try { await doFreeformPreview(); } catch(e) { showError(e.message); }
  });
  document.getElementById('btn_freeform_generate').addEventListener('click', async () => {
    try { await doFreeformGenerate(); } catch(e) { setMsg('Error: '+e.message); setBar(0); }
  });
</script>

<!-- Single file card renderer -->
<script>
  async function generateFromSingleFile() {
    const fd = new FormData();
    const f = document.querySelector('#single-file-input').files[0];
    if (!f) { toast('Please choose a file'); return; }
    fd.append('file', f);
    fd.append('bilingual', document.querySelector('#opt-bilingual').checked ? 'true' : 'false');
    fd.append('no_speculation', document.querySelector('#opt-nospec').checked ? 'true' : 'false');

    setStatus('Calling model…');
    try {
      const res = await fetch('/drafts/from-file', { method:'POST', body: fd });
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      clearReport();

      if (data.variance_items && data.variance_items.length) {
        renderVarianceList(data.variance_items);
        setStatus('Done');
        return;
      }

      const ps = (data.procurement_summary && data.procurement_summary.items && data.procurement_summary.items.length)
        ? { items: data.procurement_summary.items, insights: data.insights || data.economic_analysis || {} }
        : (data.summary && data.summary.items && data.summary.items.length)
          ? { items: data.summary.items, insights: data.insights || data.economic_analysis || {} }
          : null;
      if (ps) {
        renderProcurementSummary(ps);
        setStatus('Done');
        return;
      }

      if (data.insights) {
        renderInsights(data.insights);
        setStatus('Done');
        return;
      }

      setStatus('No variance items found.');
    } catch (e) {
      setStatus('Load failed');
      showError(e.message || e.toString());
    }
  }

  function renderProcurementSummary({ items, insights }) {
    const root = ensureSection('report-root', 'Procurement Summary');
    items.forEach((it, idx) => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="row">
          <div><b>Item</b>: ${it.item_code ?? '—'}</div>
          <div><b>Qty</b>: ${it.qty ?? '—'}</div>
          <div><b>Unit price (SAR)</b>: ${it.unit_price_sar ?? '—'}</div>
          <div><b>Amount (SAR)</b>: ${it.amount_sar ?? '—'}</div>
          <div><b>Vendor</b>: ${it.vendor_name ?? '—'}</div>
          <div><b>Doc date</b>: ${it.doc_date ?? '—'}</div>
        </div>
        <div class="desc">${escapeHtml(it.description || '')}</div>
        <div class="evidence"><i>Source: Uploaded procurement file</i></div>
      `;
      root.appendChild(card);
    });

    if (insights && (insights.totals_per_vendor || insights.top_lines_by_amount)) {
      const pre = document.createElement('pre');
      pre.textContent = JSON.stringify(insights, null, 2);
      root.appendChild(pre);
    }
  }

  function renderInsights(ins) {
    const root = ensureSection('report-root', 'Workbook Insights');
    const highlights = (ins && ins.highlights && ins.highlights.length)
      ? ('<ul>' + ins.highlights.map(x => `<li>${escapeHtml(x)}</li>`).join('') + '</ul>')
      : '<p class="muted">No highlights available.</p>';
    const cards = (ins && ins.cards)
      ? ins.cards.map(c => `<div class="kv"><b>${escapeHtml(c.title || c.sheet || 'Metric')}</b>: ${escapeHtml(String(c.value_sar ?? c.value ?? '—'))}</div>`).join('')
      : '';
    const box = document.createElement('div');
    box.className = 'card';
    box.innerHTML = `<div class="card-title">Workbook Insights</div>${highlights}${cards}`;
    root.appendChild(box);

    function appendTable(title, rows, cols) {
      if (!rows || !rows.length) return;
      const div = document.createElement('div');
      div.className = 'card';
      const th = cols.map(c => `<th>${escapeHtml(c)}</th>`).join('');
      const trs = rows.slice(0, 20).map(r => `<tr>${cols.map(c => `<td>${escapeHtml(String(r[c] ?? ''))}</td>`).join('')}</tr>`).join('');
      div.innerHTML = `<div class="card-title">${escapeHtml(title)}</div><table class="simple"><thead><tr>${th}</tr></thead><tbody>${trs}</tbody></table>`;
      root.appendChild(div);
    }
    appendTable('Top vendors by spend', (ins.tables && ins.tables['workbook::vendor_totals']) || [], ['vendor','total_sar']);
    appendTable('Largest bid spreads', (ins.tables && ins.tables['workbook::vendor_spreads']) || [], ['description','min_vendor','min_unit_sar','max_vendor','max_unit_sar','spread_pct']);
  }
</script>

<style>
  .warn { color:#f6c453; font-size:0.9rem; margin-top:.25rem }
</style>

