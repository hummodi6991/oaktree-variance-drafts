<!doctype html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Oaktree Variance Drafts</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;margin:24px;line-height:1.45}
  textarea{width:100%;height:260px;font-family:ui-monospace,Menlo,Consolas,monospace}
  .bar{height:8px;background:#eee;border-radius:4px;margin:12px 0}
  .fill{height:8px;background:#2563eb;border-radius:4px;width:0%}
  pre{background:#0b0b0b;color:#e6e6e6;padding:16px;border-radius:8px;overflow:auto}
  button{padding:8px 14px;border-radius:8px;border:1px solid #d0d0d0;background:white;cursor:pointer}
  .tabs{display:flex;gap:8px;margin-bottom:14px}
  .tab{padding:8px 12px;border-radius:8px;border:1px solid #d0d0d0}
  .tab.active{background:#2563eb;color:white;border-color:#2563eb}
  .card{border:1px solid #e5e5e5;border-radius:12px;padding:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .muted{color:#666}
  label{display:block;margin-top:10px;margin-bottom:6px;font-weight:600}
  input[type="number"]{width:200px;padding:6px 8px;border:1px solid #ccc;border-radius:6px}
</style>
<h1>Oaktree Variance Drafts</h1>
<div class="tabs">
  <div id="tab-json" class="tab active">JSON mode</div>
  <div id="tab-csv" class="tab">CSV mode</div>
</div>

<div id="pane-json" class="card">
  <p>Paste or upload JSON matching the API schema (BudgetActuals, ChangeOrders, VendorMap, CategoryMap, Config).</p>
  <textarea id="json"></textarea>
  <div style="margin-top:8px">
    <input type="file" id="jsonFile" accept=".json,application/json" />
    <button id="load">Load JSON</button>
    <button id="run">Generate</button>
  </div>
</div>

<div id="pane-csv" class="card" style="display:none">
  <div class="grid">
    <div>
      <label>Budget–Actuals CSV</label>
      <input type="file" id="csv_budget" accept=".csv,text/csv" />
    </div>
    <div>
      <label>Change Orders CSV</label>
      <input type="file" id="csv_co" accept=".csv,text/csv" />
    </div>
    <div>
      <label>Vendor Map CSV</label>
      <input type="file" id="csv_vendor" accept=".csv,text/csv" />
    </div>
    <div>
      <label>Category Map CSV</label>
      <input type="file" id="csv_cat" accept=".csv,text/csv" />
    </div>
  </div>
  <div style="margin-top:14px;display:flex;gap:20px;align-items:center;flex-wrap:wrap">
    <div><label>Materiality %</label><input id="mat_pct" type="number" value="5"></div>
    <div><label>Materiality amount (SAR)</label><input id="mat_amt" type="number" value="100000"></div>
    <label><input id="bilingual" type="checkbox" checked> Bilingual</label>
    <label><input id="no_spec" type="checkbox" checked> No speculation</label>
  </div>
  <div style="margin-top:10px">
    <button id="run_csv">Generate</button>
  </div>
  <p class="muted">Expected columns:
     <b>budget_actuals.csv</b>: project_id, <strong>period</strong>, cost_code (or category), budget_sar, actual_sar ·
     <b>change_orders.csv</b>: project_id, co_id, <strong>date</strong>, amount_sar, description, linked_cost_code, file_link ·
     <b>vendor_map.csv</b>: project_id, cost_code, vendor_name, trade, contract_id ·
     <b>category_map.csv</b>: cost_code, category.
  </p>
  <p class="muted">Tip: the uploader also accepts friendly headers <code>period(YYYY-MM)</code> and <code>date(YYYY-MM-DD)</code>; they'll be mapped automatically.</p>
</div>

<div class="bar"><div class="fill" id="bar"></div></div>
<div id="msg" class="muted"></div>
<h3>Result</h3>
<pre id="out">{}</pre>

<script>
  const el = (id)=>document.getElementById(id);
  const show = (a)=>a.style.display='';
  const hide = (a)=>a.style.display='none';
  function setBar(p){ el('bar').style.width = p+'%'; }
  function setMsg(t){ el('msg').textContent = t; }

  // Tabs
  el('tab-json').onclick = ()=>{ el('tab-json').classList.add('active'); el('tab-csv').classList.remove('active'); show(el('pane-json')); hide(el('pane-csv')); };
  el('tab-csv').onclick  = ()=>{ el('tab-csv').classList.add('active');  el('tab-json').classList.remove('active');  show(el('pane-csv'));  hide(el('pane-json')); };

  // JSON mode
  el('load').onclick = async ()=>{
    const f = el('jsonFile').files[0]; if(!f) return;
    const txt = await f.text(); el('json').value = txt;
  };
  async function callDrafts(payload){
    const res = await fetch('/drafts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!res.ok){ const t=await res.text(); throw new Error('API '+res.status+': '+t); }
    return await res.json();
  }
  el('run').onclick = async ()=>{
    try{
      setMsg('Calling model (EN)'); setBar(75);
      const payload = JSON.parse(el('json').value || '{}');
      const data = await callDrafts(payload);
      setBar(100); setMsg('Done');
      el('out').textContent = JSON.stringify(data,null,2);
    }catch(e){ setMsg('Error: '+e.message); setBar(0); }
  };

  // CSV mode
  el('run_csv').onclick = async ()=>{
    try{
      const fa = new FormData();
      const b=el('csv_budget').files[0], c=el('csv_co').files[0], v=el('csv_vendor').files[0], m=el('csv_cat').files[0];
      if(!b||!c||!v||!m){ setMsg('Please choose all four CSV files.'); return; }
      fa.append('budget_actuals', b);
      fa.append('change_orders', c);
      fa.append('vendor_map', v);
      fa.append('category_map', m);
      fa.append('materiality_pct', el('mat_pct').value||'5');
      fa.append('materiality_amount_sar', el('mat_amt').value||'100000');
      fa.append('bilingual', el('bilingual').checked ? 'true':'false');
      fa.append('enforce_no_speculation', el('no_spec').checked ? 'true':'false');
      setMsg('Uploading CSVs'); setBar(25);
      const parsed = await fetch('/ui/parse-csv', { method:'POST', body:fa });
      if(!parsed.ok){ const t=await parsed.text(); throw new Error('Parse '+parsed.status+': '+t); }
      const payload = await parsed.json();
      setMsg('Calling model (EN)'); setBar(75);
      const data = await callDrafts(payload);
      setBar(100); setMsg('Done');
      el('out').textContent = JSON.stringify(data,null,2);
    }catch(e){ setMsg('Error: '+e.message); setBar(0); }
  };
</script>

