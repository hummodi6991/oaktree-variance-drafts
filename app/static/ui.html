<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Oaktree Variance Drafts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 18px; }
    textarea { width: 100%; min-height: 280px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .row { margin: 12px 0; }
    .btn { padding: 10px 16px; border-radius: 8px; border: 1px solid #999; background:#111; color:#fff; }
    .btn:disabled { opacity: .5; }
    progress { width: 100%; height: 14px; }
    pre { background:#0b0b0b; color:#d7d7d7; padding:12px; border-radius:8px; overflow:auto; }
    .dim { color:#666 }
  </style>
</head>
<body>
  <h2>Oaktree Variance Drafts</h2>

  <div class="row">
    <p class="dim">Paste or upload JSON matching the API schema (BudgetActuals, ChangeOrders, VendorMap, CategoryMap, Config).</p>
    <textarea id="jsonBox" placeholder='{"budget_actuals":[...], "change_orders":[...], "vendor_map":[...], "category_map":[...], "config":{...}}'></textarea>
  </div>

  <div class="row">
    <input type="file" id="file" accept=".json" />
    <button id="loadFile" class="btn" type="button">Load JSON</button>
  </div>

  <div class="row">
    <button id="genBtn" class="btn" type="button">Generate</button>
  </div>

  <div class="row">
    <div id="status" class="dim">Idle</div>
    <progress id="bar" max="100" value="0"></progress>
  </div>

  <h3>Result</h3>
  <pre id="result">{}</pre>

<script>
// --- CONFIG ---
const ENDPOINT = '/drafts';              // Synchronous endpoint (works per your Swagger test)
const API_KEY_HEADER = 'X-API-Key';      // Only required if your backend enforces API key
const API_KEY = '';                      // Leave empty for demo, or paste a key if required

document.getElementById('loadFile').onclick = async () => {
  const f = document.getElementById('file').files?.[0];
  if (!f) return alert('Choose a .json file first');
  const text = await f.text();
  document.getElementById('jsonBox').value = text;
};

document.getElementById('genBtn').onclick = generate;

async function generate() {
  const btn = document.getElementById('genBtn');
  const bar = document.getElementById('bar');
  const status = document.getElementById('status');
  const result = document.getElementById('result');

  let payload;
  try {
    payload = JSON.parse(document.getElementById('jsonBox').value);
  } catch (e) {
    alert('Invalid JSON: ' + e.message);
    return;
  }

  btn.disabled = true;
  result.textContent = '';
  bar.value = 5;   status.textContent = 'Validating input…';

  try {
    // Minimal sanity checks to fail fast client-side
    if (!Array.isArray(payload.budget_actuals)) throw new Error('Missing/invalid "budget_actuals" array');
    if (!Array.isArray(payload.category_map)) throw new Error('Missing/invalid "category_map" array');
    if (!payload.config) throw new Error('Missing "config" object');

    bar.value = 25; status.textContent = 'Connecting to API…';

    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 180000); // 3 minutes

    const headers = {'Content-Type': 'application/json'};
    if (API_KEY) headers[API_KEY_HEADER] = API_KEY;

    const resp = await fetch(ENDPOINT, {
      method: 'POST',
      headers,
      body: JSON.stringify(payload),
      signal: controller.signal
    });

    clearTimeout(timeout);

    if (!resp.ok) {
      const text = await resp.text().catch(()=>'');
      throw new Error(`HTTP ${resp.status} ${resp.statusText}\n${text}`);
    }

    bar.value = 75; status.textContent = 'Formatting result…';

    let data;
    try { data = await resp.json(); }
    catch (e) {
      const text = await resp.text().catch(()=>'(no body)');
      throw new Error('Response was not valid JSON:\n' + text);
    }

    result.textContent = JSON.stringify(data, null, 2);
    bar.value = 100; status.textContent = 'Done';
  } catch (err) {
    bar.value = 100;
    status.textContent = 'Failed';
    result.textContent = String(err?.stack || err);
  } finally {
    btn.disabled = false;
  }
}
</script>
</body>
</html>
