<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Oaktree Variance Drafts — Demo UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; max-width: 960px; }
    h1 { margin-bottom: 8px; }
    fieldset { border: 1px solid #ddd; padding: 12px; margin-bottom: 16px; }
    label { display: block; margin: 6px 0 2px; font-weight: 600; }
    input[type="number"] { width: 140px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .muted { color: #666; font-size: 14px; }
    pre { background: #0b1020; color: #d1fff3; padding: 12px; overflow: auto; border-radius: 6px; }
    button { padding: 10px 16px; border: 0; background: #0a66ff; color: white; border-radius: 6px; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h1>Oaktree Variance Drafts — Demo</h1>
  <p class="muted">Upload the four CSVs, set the rules, and click Generate.</p>

  <fieldset>
    <legend>Connection</legend>
    <label for="baseUrl">Base URL</label>
    <input id="baseUrl" type="url" style="width:100%" />
    <label for="apiKey">API key (<span class="muted">demo only — rotate after</span>)</label>
    <input id="apiKey" type="password" style="width:100%" />
  </fieldset>

  <fieldset>
    <legend>Files</legend>
    <div class="grid">
      <div>
        <label for="ba">Budget–Actuals CSV</label>
        <input id="ba" type="file" accept=".csv" />
      </div>
      <div>
        <label for="co">Change Orders CSV</label>
        <input id="co" type="file" accept=".csv" />
      </div>
      <div>
        <label for="vm">Vendor Map CSV</label>
        <input id="vm" type="file" accept=".csv" />
      </div>
      <div>
        <label for="cm">Category Map CSV</label>
        <input id="cm" type="file" accept=".csv" />
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Materiality & Style</legend>
    <div class="grid">
      <div>
        <label for="matPct">Materiality % (absolute)</label>
        <input id="matPct" type="number" value="5" min="0" step="0.5" />
      </div>
      <div>
        <label for="matAmt">Materiality amount (SAR)</label>
        <input id="matAmt" type="number" value="100000" min="0" step="10000" />
      </div>
    </div>
    <div style="margin-top:8px;">
      <label><input id="bilingual" type="checkbox" checked /> Generate EN + AR</label>
      <label><input id="noSpec" type="checkbox" checked /> No speculation (documented drivers only)</label>
    </div>
  </fieldset>

  <button id="goBtn">Generate drafts</button>

  <h2 style="margin-top:24px;">Result</h2>
  <pre id="out">(no result yet)</pre>

  <script>
    const $ = id => document.getElementById(id);
    window.addEventListener('DOMContentLoaded', () => {
      $('baseUrl').value = window.location.origin;
    });

    function parseCSV(file) {
      return new Promise((resolve, reject) => {
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: results => resolve(results.data),
          error: err => reject(err)
        });
      });
    }

    async function generate() {
      const btn = $('goBtn');
      btn.disabled = true;
      $('out').textContent = 'Processing…';

      try {
        const [ba, co, vm, cm] = await Promise.all([
          parseCSV($('ba').files[0]),
          parseCSV($('co').files[0]),
          parseCSV($('vm').files[0]),
          parseCSV($('cm').files[0]),
        ]);

        const body = {
          budget_actuals: ba,
          change_orders: co,
          vendor_map: vm,
          category_map: cm,
          config: {
            materiality_pct: Number($('matPct').value),
            materiality_amount_sar: Number($('matAmt').value),
            bilingual: $('bilingual').checked,
            enforce_no_speculation: $('noSpec').checked
          }
        };

        const resp = await fetch(`${$('baseUrl').value}/drafts`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': $('apiKey').value.trim()
          },
          body: JSON.stringify(body)
        });

        const json = await resp.json();
        $('out').textContent = JSON.stringify(json, null, 2);
      } catch (e) {
        $('out').textContent = 'Error: ' + (e?.message || e);
      } finally {
        btn.disabled = false;
      }
    }

    $('goBtn').addEventListener('click', generate);
  </script>
</body>
</html>
