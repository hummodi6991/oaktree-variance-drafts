<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Oaktree Variance Drafts — CSV/Excel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Simple, readable default styling -->
  <style>
    :root { --bg:#0b0d10; --card:#12161b; --accent:#24a0ed; --muted:#9aa4ad; --ok:#21c27a; --err:#ff6b6b; }
    html,body { background:var(--bg); color:#e9eef2; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin:0; }
    .wrap { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    h1 { font-size: 22px; margin: 0 0 16px; }
    .card { background: var(--card); border: 1px solid #1e242d; border-radius: 10px; padding: 16px; margin-bottom: 16px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap: 12px; }
    .field { display:flex; flex-direction:column; gap:6px; }
    label { font-size: 13px; color: var(--muted); }
    input[type="file"], input[type="number"], input[type="text"] { background:#0e1217; color:#e9eef2; border:1px solid #25303a; border-radius: 8px; padding:10px; }
    .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    .btn { background: var(--accent); color:white; border:none; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:600; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .hint { font-size:12px; color:var(--muted); }
    .status { font-size:13px; margin-top:8px; color:var(--muted); }
    .status.ok { color: var(--ok); }
    .status.err { color: var(--err); white-space: pre-wrap; }
    .bar { height: 8px; background:#1e242d; border-radius:999px; overflow:hidden; }
    .bar > div { width:0%; height:100%; background: linear-gradient(90deg, var(--accent), #35d0ff); transition: width .25s ease; }
    details { background:#0e1217; border:1px solid #1e242d; border-radius:10px; padding:12px; }
    summary { cursor:pointer; color:#c9d5df; }
    pre { background:#0a0d11; border:1px solid #1e242d; border-radius:10px; padding:12px; overflow:auto; }
    .muted { color: var(--muted); }
  </style>
  <!-- CSV + Excel parsers (client-side) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Oaktree Variance Drafts</h1>

    <div class="card">
      <div class="grid" style="margin-bottom:12px">
        <div class="field">
          <label>Budget–Actuals (CSV or Excel)</label>
          <input id="fBudget" type="file" accept=".csv,.xlsx,.xls" />
          <div class="hint">Expected columns: project_id, period, category, budget_sar, actual_sar</div>
        </div>
        <div class="field">
          <label>Change Orders (CSV or Excel)</label>
          <input id="fCO" type="file" accept=".csv,.xlsx,.xls" />
          <div class="hint">Expected columns: project_id, linked_cost_code, description, file_link</div>
        </div>
        <div class="field">
          <label>Vendor Map (CSV or Excel)</label>
          <input id="fVendor" type="file" accept=".csv,.xlsx,.xls" />
          <div class="hint">Expected columns: project_id, cost_code, vendor_name, trade, contract_id</div>
        </div>
        <div class="field">
          <label>Category Map (CSV or Excel)</label>
          <input id="fCat" type="file" accept=".csv,.xlsx,.xls" />
          <div class="hint">Expected columns: cost_code, category</div>
        </div>
      </div>

      <div class="grid" style="margin-bottom:12px">
        <div class="field">
          <label>Materiality %</label>
          <input id="materialityPct" type="number" value="5" min="0" max="100" />
        </div>
        <div class="field">
          <label>Materiality amount (SAR)</label>
          <input id="materialityAmt" type="number" value="100000" min="0" />
        </div>
        <div class="field">
          <label class="muted">Options</label>
          <div class="row">
            <label><input id="optBilingual" type="checkbox" checked /> Bilingual</label>
            <label><input id="optNoSpec" type="checkbox" checked /> No speculation</label>
          </div>
        </div>
      </div>

      <div class="row" style="margin-bottom:8px">
        <button id="btnGen" class="btn">Generate</button>
        <div id="status" class="status">Idle</div>
      </div>
      <div class="bar"><div id="bar" style="width:0%"></div></div>
    </div>

    <div class="card">
      <details open>
        <summary>Raw JSON (for analysts)</summary>
        <pre id="out">{}</pre>
      </details>
    </div>
  </div>

<script>
  // ---------- Helpers ----------
  const $ = id => document.getElementById(id);
  const setStatus = (msg, cls='') => { const s=$('status'); s.textContent=msg; s.className='status ' + cls; };
  const setBar = pct => { $('bar').style.width = Math.max(0, Math.min(100, pct)) + '%'; };

  function normalizeKeys(row) {
    const out = {};
    for (const [k,v] of Object.entries(row)) {
      if (k == null) continue;
      const key = String(k).trim().toLowerCase().replace(/\s+/g,'_');
      out[key] = v;
    }
    return out;
  }

  function mapBudget(rows) {
    return rows.map(r => {
      const x = normalizeKeys(r);
      return {
        project_id: x.project_id ?? x.project ?? x.projectname ?? '',
        period:     x.period ?? x.month ?? x.date ?? '',
        category:   x.category ?? '',
        budget_sar: Number(x.budget_sar ?? x.budget ?? x.budget_amount ?? 0),
        actual_sar: Number(x.actual_sar ?? x.actual ?? x.actual_amount ?? 0),
      };
    }).filter(r => r.project_id);
  }

  function mapChangeOrders(rows) {
    return rows.map(r => {
      const x = normalizeKeys(r);
      return {
        project_id:       x.project_id ?? x.project ?? '',
        linked_cost_code: x.linked_cost_code ?? x.cost_code ?? x.code ?? '',
        description:      x.description ?? x.desc ?? '',
        file_link:        x.file_link ?? x.link ?? x.url ?? ''
      };
    }).filter(r => r.project_id);
  }

  function mapVendors(rows) {
    return rows.map(r => {
      const x = normalizeKeys(r);
      return {
        project_id:  x.project_id ?? x.project ?? '',
        cost_code:   x.cost_code ?? x.code ?? '',
        vendor_name: x.vendor_name ?? x.vendor ?? x.supplier ?? '',
        trade:       x.trade ?? '',
        contract_id: x.contract_id ?? x.contract ?? ''
      };
    }).filter(r => r.project_id);
  }

  function mapCategories(rows) {
    return rows.map(r => {
      const x = normalizeKeys(r);
      return { cost_code: x.cost_code ?? x.code ?? '', category: x.category ?? '' };
    }).filter(r => r.cost_code);
  }

  function readCSV(file) {
    return new Promise((resolve, reject) => {
      Papa.parse(file, {
        header:true, dynamicTyping:true, skipEmptyLines:true,
        complete: res => resolve(res.data),
        error: reject
      });
    });
  }

  function readExcel(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, {type:'array'});
          const ws = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(ws, {defval: null});
          resolve(json);
        } catch(err) { reject(err); }
      };
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  async function fileToRows(file) {
    if (!file) return [];
    const ext = file.name.split('.').pop().toLowerCase();
    if (ext === 'csv') return readCSV(file);
    if (ext === 'xlsx' || ext === 'xls') return readExcel(file);
    throw new Error('Unsupported file type: ' + ext);
  }

  // ---------- Main click ----------
  $('btnGen').addEventListener('click', async () => {
    try {
      setStatus('Reading files…'); setBar(10); $('btnGen').disabled = true;

      const [baRows, coRows, vmRows, cmRows] = await Promise.all([
        fileToRows($('fBudget').files[0]),
        fileToRows($('fCO').files[0]),
        fileToRows($('fVendor').files[0]),
        fileToRows($('fCat').files[0]),
      ]);

      setStatus('Building payload…'); setBar(30);

      const payload = {
        budget_actuals: mapBudget(baRows),
        change_orders:  mapChangeOrders(coRows),
        vendor_map:     mapVendors(vmRows),
        category_map:   mapCategories(cmRows),
        config: {
          materiality_pct: Number($('materialityPct').value || 0),
          materiality_amount_sar: Number($('materialityAmt').value || 0),
          bilingual: $('optBilingual').checked,
          enforce_no_speculation: $('optNoSpec').checked
        }
      };

      // quick guard: require at least Budget–Actuals
      if (!payload.budget_actuals.length) {
        setStatus('Please provide at least a Budget–Actuals file.', 'err'); setBar(0); $('btnGen').disabled=false; return;
      }

      setStatus('Calling API…'); setBar(60);
      const resp = await fetch('/drafts', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        const txt = await resp.text();
        setStatus('API error: ' + resp.status + ' ' + resp.statusText + '\n' + txt, 'err');
        setBar(0); $('btnGen').disabled=false; return;
      }

      const data = await resp.json();
      setStatus('Done', 'ok'); setBar(100);
      $('out').textContent = JSON.stringify(data, null, 2);
    } catch (err) {
      setStatus(String(err && err.message ? err.message : err), 'err');
      setBar(0);
    } finally {
      $('btnGen').disabled = false;
      setTimeout(() => setBar(0), 1200);
    }
  });
</script>
</body>
</html>

