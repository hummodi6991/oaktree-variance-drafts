<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Oaktree Variance Drafts — CSV/Excel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Simple, readable default styling -->
  <style>
    :root { --bg:#0b0d10; --card:#12161b; --accent:#24a0ed; --muted:#9aa4ad; --ok:#21c27a; --err:#ff6b6b; }
    html,body { background:var(--bg); color:#e9eef2; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin:0; }
    .wrap { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    h1 { font-size: 22px; margin: 0 0 16px; }
    .card { background: var(--card); border: 1px solid #1e242d; border-radius: 10px; padding: 16px; margin-bottom: 16px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap: 12px; }
    .field { display:flex; flex-direction:column; gap:6px; }
    label { font-size: 13px; color: var(--muted); }
    input[type="file"], input[type="number"], input[type="text"] { background:#0e1217; color:#e9eef2; border:1px solid #25303a; border-radius: 8px; padding:10px; }
    .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    .btn { background: var(--accent); color:white; border:none; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:600; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .hint { font-size:12px; color:var(--muted); }
    .status { font-size:13px; margin-top:8px; color:var(--muted); }
    .status.ok { color: var(--ok); }
    .status.err { color: var(--err); white-space: pre-wrap; }
    .bar { height: 8px; background:#1e242d; border-radius:999px; overflow:hidden; }
    .bar > div { width:0%; height:100%; background: linear-gradient(90deg, var(--accent), #35d0ff); transition: width .25s ease; }
    details { background:#0e1217; border:1px solid #1e242d; border-radius:10px; padding:12px; }
    summary { cursor:pointer; color:#c9d5df; }
    pre { background:#0a0d11; border:1px solid #1e242d; border-radius:10px; padding:12px; overflow:auto; }
    .muted { color: var(--muted); }
    .report { display: grid; gap: 16px; }
    .report__summary { padding: 12px 0; border-bottom: 1px solid #2a2a2a; }
    .report__summary h2 { margin: 0 0 6px 0; }
    .report__card { padding: 14px; border: 1px solid #2a2a2a; border-radius: 8px; background: #0e0e0e; }
    .card__head { display:flex; align-items:flex-start; justify-content:space-between; gap:16px; }
    .figures { display:flex; gap:16px; }
    .figures .label { display:block; font-size:12px; color:#9aa; }
    .figures .val { font-weight:600; }
    .pill { background:#1f2937; color:#e5e7eb; padding:2px 8px; border-radius:999px; font-size:12px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; margin-top:10px; }
    .chips { display:flex; gap:6px; flex-wrap:wrap; }
    .chip { background:#111827; border:1px solid #374151; padding:2px 8px; border-radius:999px; font-size:12px; }
    .muted { color:#9aa; }
    .tight { margin:0; padding-left:18px; }
    .blk { margin-top:10px; }
    .rtl { direction: rtl; text-align: start; }
  </style>
  <!-- CSV + Excel parsers (client-side) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Oaktree Variance Drafts</h1>

    <div class="card">
      <div class="grid" style="margin-bottom:12px">
        <div class="field">
          <label>Budget–Actuals (CSV or Excel)</label>
          <input id="fBudget" type="file" accept=".csv,.xlsx,.xls" />
          <div class="hint">Expected columns: project_id, period, <b>cost_code</b>, category, budget_sar, actual_sar</div>
        </div>
        <div class="field">
          <label>Change Orders (CSV or Excel)</label>
          <input id="fCO" type="file" accept=".csv,.xlsx,.xls" />
          <div class="hint">Expected columns: project_id, linked_cost_code, description, file_link, <b>co_id</b>, <b>date</b>, <b>amount_sar</b></div>
        </div>
        <div class="field">
          <label>Vendor Map (CSV or Excel)</label>
          <input id="fVendor" type="file" accept=".csv,.xlsx,.xls" />
          <div class="hint">Expected columns: project_id, cost_code, vendor_name, trade, contract_id</div>
        </div>
        <div class="field">
          <label>Category Map (CSV or Excel)</label>
          <input id="fCat" type="file" accept=".csv,.xlsx,.xls" />
          <div class="hint">Expected columns: cost_code, category</div>
        </div>
      </div>

      <div class="grid" style="margin-bottom:12px">
        <div class="field">
          <label>Materiality %</label>
          <input id="materialityPct" type="number" value="5" min="0" max="100" />
        </div>
        <div class="field">
          <label>Materiality amount (SAR)</label>
          <input id="materialityAmt" type="number" value="100000" min="0" />
        </div>
        <div class="field">
          <label class="muted">Options</label>
          <div class="row">
            <label><input id="optBilingual" type="checkbox" checked /> Bilingual</label>
            <label><input id="optNoSpec" type="checkbox" checked /> No speculation</label>
            <label><input id="optLocalOnly" type="checkbox" /> Local-only mode</label>
          </div>
        </div>
      </div>

      <div class="row" style="margin-bottom:8px">
        <button id="btnGen" class="btn">Generate</button>
        <span id="modeBadge" class="pill" style="display:none"></span>
      <div id="status" class="status">Idle</div>
      </div>
      <div class="bar"><div id="bar" style="width:0%"></div></div>
      <details id="error-details" style="display:none;margin-top:8px;">
        <summary>Error details</summary>
        <pre id="error-stack"></pre>
      </details>
    </div>

    <div class="card">
      <div class="field">
        <label>Single Data File (CSV, Excel, Word, PDF, or Text)</label>
        <input id="fSingle" type="file" accept=".csv,.xlsx,.xls,.pdf,.docx,.txt,.md,.rtf" />
        <div class="hint">Use this for incomplete or messy data in one file. Uploading here disables the 4-file track.</div>
        <button id="btnSingle" class="btn" style="margin-top:8px">Generate from file</button>
      </div>
    </div>

    <div class="card">
      <div id="result"></div>
    </div>
  </div>

<script>
  // ---------- Helpers ----------
  const $ = id => document.getElementById(id);
  const showErrorDetails = err => {
    const det = $('error-details');
    const pre = $('error-stack');
    if (!det || !pre) return;
    if (!err) {
      det.style.display = 'none';
      pre.textContent = '';
      return;
    }
    det.style.display = 'block';
    det.open = true;
    const msg = err && err.stack ? err.stack :
      (typeof err === 'string' ? err : JSON.stringify(err, null, 2));
    pre.textContent = msg;
  };
  const clearErrorDetails = () => showErrorDetails(null);
  const setStatus = (msg, cls='') => {
    const s = $('status');
    s.textContent = msg;
    s.className = 'status ' + cls;
    if (cls !== 'err') { clearErrorDetails(); }
  };
  const setBar = pct => { $('bar').style.width = Math.max(0, Math.min(100, pct)) + '%'; };
  window.addEventListener('error', e => {
    setStatus(e.message || 'Error', 'err');
    showErrorDetails(e.error || e.message || e);
  });
  window.addEventListener('unhandledrejection', e => {
    const reason = e.reason;
    const msg = reason && reason.message ? reason.message : String(reason);
    setStatus(msg, 'err');
    showErrorDetails(reason);
  });

  const MODE_TOOLTIP = "If AI-assisted, extracted text and key figures are sent to OpenAI to draft content. 'No speculation' enforces fact-bound output.";
  function updateModeBadge(meta) {
    const badge = $('modeBadge');
    if (!badge) return;
    badge.title = MODE_TOOLTIP;
    if (meta && meta.llm_used) {
      const model = meta.model ? ` (${meta.model})` : '';
      const prov = meta.provider || 'OpenAI';
      badge.textContent = `AI-assisted • ${prov}${model}`;
      badge.style.display = 'inline-block';
    } else if (meta) {
      badge.textContent = 'Local-only (no external model)';
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }
  }

  function normalizeKeys(row) {
    const out = {};
    for (const [k,v] of Object.entries(row)) {
      if (k == null) continue;
      // lower, trim, collapse spaces; normalize dashes/underscores; drop stray punctuation
      let key = String(k).toLowerCase().trim();
      key = key.replace(/[\u200B-\u200D\uFEFF]/g, '');       // zero-width
      key = key.replace(/[\.\(\)\[\]]/g, ' ');               // dots/brackets → space
      key = key.replace(/[-]+/g, ' ').replace(/_+/g, ' ');   // dashes/underscores → space
      key = key.replace(/\s+/g, ' ').trim().replace(/\s+/g,'_'); // collapse spaces → underscore
      out[key] = v;
    }
    return out;
  }

  /* Tolerance helpers: header aliases, numbers, dates, period formats */
  function aliasValue(obj, keys, fallback='') {
    for (const k of keys) {
      const v = obj[k];
      if (v !== undefined && v !== null && String(v).trim() !== '') return v;
    }
    return fallback;
  }
  function toNumber(val) {
    if (val === null || val === undefined) return 0;
    let s = String(val).trim().toLowerCase();
    s = s.replace(/sar|ر\.?س|ريال/g,'');        // remove currency words
    s = s.replace(/[, \s]/g,'');                 // remove commas/spaces
    // negatives in parentheses: (45000)
    const neg = /^\(.*\)$/.test(s);
    if (neg) s = s.replace(/^\(|\)$/g,'');
    const n = Number(s);
    return Number.isFinite(n) ? (neg ? -n : n) : 0;
  }
  function toIsoDate(val) {
    if (val === null || val === undefined || val === '') return '';
    const s = String(val).trim();
    // Try common formats
    const tryParse = (fmt) => {
      // very light parser instead of full libs; fallback to Date constructor
      return null;
    };
    // YYYY-MM-DD or YYYY/MM/DD
    let m = s.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
    if (m) {
      const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
      return `${y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    }
    // DD-MM-YYYY or DD/MM/YYYY
    m = s.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/);
    if (m) {
      const d = Number(m[1]), mo = Number(m[2]), y = Number(m[3]);
      return `${y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    }
    // Month Year (Jan 2025 / January 2025) → first of month
    m = s.match(/^(jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)[a-z]*\s+(\d{4})$/i);
    if (m) {
      const monthNames = {jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,sept:9,oct:10,nov:11,dec:12};
      const mo = monthNames[m[1].slice(0,3).toLowerCase()];
      const y = Number(m[2]);
      return `${y}-${String(mo).padStart(2,'0')}-01`;
    }
    // Fallback to Date parsing
    const d = new Date(s);
    if (!isNaN(d)) return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    return '';
  }
  function toPeriodYYYYMM(val) {
    if (val === null || val === undefined || val === '') return '';
    const s = String(val).trim();
    // YYYY-MM or YYYY/MM
    let m = s.match(/^(\d{4})[-\/](\d{1,2})$/);
    if (m) return `${m[1]}-${String(Number(m[2])).padStart(2,'0')}`;
    // Month Year
    m = s.match(/^(jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)[a-z]*\s+(\d{4})$/i);
    if (m) {
      const monthNames = {jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,sept:9,oct:10,nov:11,dec:12};
      const mo = monthNames[m[1].slice(0,3).toLowerCase()];
      return `${m[2]}-${String(mo).padStart(2,'0')}`;
    }
    // If a full date, reduce to YYYY-MM
    const iso = toIsoDate(s);
    if (iso) return iso.slice(0,7);
    return '';
  }
  function normCostCode(s) {
    if (s === null || s === undefined) return '';
    return String(s).trim().toUpperCase().replace(/[\s_]+/g,'').replace(/–/g,'-');
  }

  function mapBudget(rows) {
    return rows.map(r => {
      const x = normalizeKeys(r);
      const project_id = aliasValue(x, ['project_id','project','projectname','proj_id']);
      const periodRaw  = aliasValue(x, ['period','month','month_year','date','posting_period']);
      const cost_raw   = aliasValue(x, ['cost_code','costcode','cost_code','gl_code','glcode','account_code','account_code','code','gl']);
      const category   = aliasValue(x, ['category','cat','cost_category','reporting_category','group']);
      const budgetRaw  = aliasValue(x, ['budget_sar','budget','budget_amount','planned_sar','plan']);
      const actualRaw  = aliasValue(x, ['actual_sar','actual','actual_amount','spent','spend_sar']);

      return {
        project_id: project_id || '',
        period: toPeriodYYYYMM(periodRaw),
        cost_code: normCostCode(cost_raw),
        category: category || '',
        budget_sar: toNumber(budgetRaw),
        actual_sar: toNumber(actualRaw),
      };
    }).filter(r => r.project_id && r.cost_code);
  }
  function mapChangeOrders(rows) {
    return rows.map(r => {
      const x = normalizeKeys(r);
      const project_id = aliasValue(x, ['project_id','project','projectname','proj_id']);
      const cost_raw   = aliasValue(x, ['linked_cost_code','cost_code','costcode','code','gl_code','glcode','account_code']);
      const desc       = aliasValue(x, ['description','desc','details','subject']);
      const link       = aliasValue(x, ['file_link','link','url','evidence','evidence_link','file']);
      const coid       = aliasValue(x, ['co_id','change_order_id','co_number','co number','coid','id']);
      const dateRaw    = aliasValue(x, ['date','co_date','change_order_date','issued_date']);
      const amtRaw     = aliasValue(x, ['amount_sar','amount','value','total','sar','amount_(sar)','total_sar']);

      return {
        project_id: project_id || '',
        linked_cost_code: normCostCode(cost_raw),
        description: desc || '',
        file_link: link || '',
        co_id: coid || '',
        date: toIsoDate(dateRaw),
        amount_sar: toNumber(amtRaw)
      };
    }).filter(r => r.project_id && r.linked_cost_code);
  }

  function mapVendors(rows) {
    return rows.map(r => {
      const x = normalizeKeys(r);
      const project_id = aliasValue(x, ['project_id','project','projectname','proj_id']);
      const cost_raw   = aliasValue(x, ['cost_code','costcode','code','gl_code','glcode','account_code']);
      const vname      = aliasValue(x, ['vendor_name','vendor','supplier','supplier_name','contractor','contractor_name']);
      const trade      = aliasValue(x, ['trade','discipline','category','scope']);
      const cid        = aliasValue(x, ['contract_id','contract','contract_no','contract_no.','contract_number','po','po_number']);
      return {
        project_id: project_id || '',
        cost_code: normCostCode(cost_raw),
        vendor_name: vname || '',
        trade: trade || '',
        contract_id: cid || ''
      };
    }).filter(r => r.project_id && r.cost_code);
  }

  function mapCategories(rows) {
    return rows.map(r => {
      const x = normalizeKeys(r);
      const cost_raw = aliasValue(x, ['cost_code','costcode','code','gl_code','glcode','account_code']);
      const cat      = aliasValue(x, ['category','cat','reporting_category','group']);
      return { cost_code: normCostCode(cost_raw), category: cat || '' };
    }).filter(r => r.cost_code);
  }

  function readCSV(file) {
    return new Promise((resolve, reject) => {
      Papa.parse(file, {
        header:true, dynamicTyping:true, skipEmptyLines:true,
        complete: res => resolve(res.data),
        error: reject
      });
    });
  }

  function readExcel(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, {type:'array'});
          const ws = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(ws, {defval: null});
          resolve(json);
        } catch(err) { reject(err); }
      };
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  async function fileToRows(file) {
    if (!file) return [];
    const ext = file.name.split('.').pop().toLowerCase();
    if (ext === 'csv') return readCSV(file);
    if (ext === 'xlsx' || ext === 'xls') return readExcel(file);
    throw new Error('Unsupported file type: ' + ext);
  }

  function trackToggle() {
    const single = $('fSingle');
    const others = ['fBudget','fCO','fVendor','fCat'].map(id => $(id));
    const singleActive = single.files.length > 0;
    others.forEach(inp => inp.disabled = singleActive);
    single.disabled = others.some(inp => inp.files.length > 0);
  }
  ['fSingle','fBudget','fCO','fVendor','fCat'].forEach(id => {
    $(id).addEventListener('change', trackToggle);
  });
  trackToggle();

  $('btnSingle').addEventListener('click', async () => {
    try {
      if (['fBudget','fCO','fVendor','fCat'].some(id => $(id).files.length)) {
        setStatus('Clear the structured uploads to use the single file mode.', 'err');
        return;
      }
      const f = $('fSingle').files[0];
      if (!f) { setStatus('Please choose a file.', 'err'); return; }
      const fd = new FormData();
      fd.append('file', f);
      fd.append('bilingual', $('optBilingual').checked ? 'true' : 'false');
      fd.append('no_speculation', $('optNoSpec').checked ? 'true' : 'false');
      setStatus('Calling API…'); setBar(60); $('btnSingle').disabled = true;
      const resp = await fetch('/drafts/from-file', { method: 'POST', body: fd });
      if (!resp.ok) {
        const txt = await resp.text();
        setStatus('API error: ' + resp.status + ' ' + resp.statusText + '\n' + txt, 'err');
        showErrorDetails(txt);
        let parsed;
        try { parsed = JSON.parse(txt); } catch (_) {}
        setBar(0); $('btnSingle').disabled = false; return;
      }
      const result = await resp.json();
      updateModeBadge(result._meta);
      if (result && result.error) {
        setStatus(result.error, 'err'); setBar(0); $('btnSingle').disabled = false;
        $('result').textContent = result.error;
        showErrorDetails(result);
        return;
      }
      setStatus('Done', 'ok'); setBar(100);
      renderFromFileResult(result);
    } catch (err) {
      setStatus(String(err && err.message ? err.message : err), 'err'); setBar(0);
      showErrorDetails(err);
    } finally {
      $('btnSingle').disabled = false; setTimeout(() => setBar(0), 1200);
    }
  });

  // ---------- Main click ----------
  $('btnGen').addEventListener('click', async () => {
    try {
      if ($('fSingle').files.length) {
        setStatus('Remove the single data file to use the structured track.', 'err');
        return;
      }
      setStatus('Reading files…'); setBar(10); $('btnGen').disabled = true;

      const [baRows, coRows, vmRows, cmRows] = await Promise.all([
        fileToRows($('fBudget').files[0]),
        fileToRows($('fCO').files[0]),
        fileToRows($('fVendor').files[0]),
        fileToRows($('fCat').files[0]),
      ]);

      setStatus('Building payload…'); setBar(30);

      const payload = {
        budget_actuals: mapBudget(baRows),
        change_orders:  mapChangeOrders(coRows),
        vendor_map:     mapVendors(vmRows),
        category_map:   mapCategories(cmRows),
        config: {
          materiality_pct: Number($('materialityPct').value || 0),
          materiality_amount_sar: Number($('materialityAmt').value || 0),
          bilingual: $('optBilingual').checked,
          enforce_no_speculation: $('optNoSpec').checked
        }
      };

      // quick guard: require at least Budget–Actuals
      if (!payload.budget_actuals.length) {
        setStatus('Please provide at least a Budget–Actuals file.', 'err'); setBar(0); $('btnGen').disabled=false; return;
      }

      // preflight validation for cost_code
      const missingCost = payload.budget_actuals.filter(r => !r.cost_code || String(r.cost_code).trim() === '');
      if (missingCost.length) {
        const sample = missingCost[0] || {};
        setStatus(
          `Budget–Actuals is missing 'cost_code' on ${missingCost.length} row(s). ` +
          `Example: project_id=${sample.project_id ?? ''}, period=${sample.period ?? ''}. ` +
          `Add a 'cost_code' column (e.g., MAT-001) and try again.`, 'err'
        );
        setBar(0);
        $('btnGen').disabled = false;
        return;
      }
      // Validate Change Orders required fields: co_id, date, amount_sar
      const missingCO = payload.change_orders.filter(r => !r.co_id || !r.date || !(r.amount_sar || r.amount_sar === 0));
      if (missingCO.length) {
        const sample = missingCO[0] || {};
        setStatus(
          `Change Orders file is missing required columns on ${missingCO.length} row(s). ` +
          `Each row must include co_id, date, and amount_sar. ` +
          `Example with issue: project_id=${sample.project_id ?? ''}, linked_cost_code=${sample.linked_cost_code ?? ''}.`,
          'err'
        );
        setBar(0);
        $('btnGen').disabled = false;
        return;
      }

      setStatus('Calling API…'); setBar(60);
      const headers = { 'Content-Type':'application/json' };
      const resp = await fetch('/drafts', {
        method:'POST',
        headers,
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        const txt = await resp.text();
        setStatus('API error: ' + resp.status + ' ' + resp.statusText + '\n' + txt, 'err');
        showErrorDetails(txt);
        let parsed;
        try { parsed = JSON.parse(txt); } catch (_) {}
        setBar(0); $('btnGen').disabled=false; return;
      }

      const data = await resp.json();
      updateModeBadge(data._meta);
      setStatus('Done', 'ok'); setBar(100);
      renderResult(data);
    } catch (err) {
      setStatus(String(err && err.message ? err.message : err), 'err');
      setBar(0);
      showErrorDetails(err);
    } finally {
      $('btnGen').disabled = false;
      setTimeout(() => setBar(0), 1200);
    }
  });

  function renderResult(data) {
    if (data && data.kind === 'summary') {
      const ins = Object.assign({ title: data.message || 'Summary' }, data.insights || {});
      renderInsights(ins);
      return;
    }
    // Normalize items
    const items = Array.isArray(data?.variances) ? data.variances : (Array.isArray(data) ? data : []);
    const container = document.createElement('div');
    container.className = 'report';

    // Order variances consistently by project, period, then category
    items.sort((a, b) => {
      const va = a.variance ?? a;
      const vb = b.variance ?? b;
      return (va.project_id || '').localeCompare(vb.project_id || '') ||
             (va.period || '').localeCompare(vb.period || '') ||
             (va.category || '').localeCompare(vb.category || '');
    });

    if (!items.length) {
      $('result').textContent = 'No budget-vs-actual data detected.';
      return;
    }

    // Summary
    const total = items.length;
    const hdr = document.createElement('div');
    hdr.className = 'report__summary';
    hdr.innerHTML = `<h2>Variance Drafts (${total})</h2>
      <p>This report shows each variance with key figures, drivers, vendors, evidence links, and bilingual drafts.</p>`;
    container.appendChild(hdr);

    // Cards
    items.forEach((it, idx) => {
      const v = it.variance ?? it; // tolerate either shape
      const card = document.createElement('section');
      card.className = 'report__card';

      // Header
      const title = `
        <div class="card__head">
          <div>
            <h3>${(v.project_id ?? 'Project')}: <span class="pill">${v.category ?? ''}</span></h3>
            <div class="muted">Period: ${v.period ?? ''} · Cost code: ${v.cost_code ?? ''}</div>
          </div>
          <div class="figures">
            <div><span class="label">Budget</span><span class="val">${fmtNumber(v.budget_sar)}</span></div>
            <div><span class="label">Actual</span><span class="val">${fmtNumber(v.actual_sar)}</span></div>
            <div><span class="label">Variance</span><span class="val">${fmtNumber(v.variance_sar)} (${fmtPct(v.variance_pct)})</span></div>
          </div>
        </div>
      `;

      // Lists
      const drivers = (v.drivers ?? []).map(d => `<li>${escapeHtml(d)}</li>`).join('') || '<li class="muted">—</li>';
      const vendors = (v.vendors ?? []).map(s => `<span class="chip">${escapeHtml(s)}</span>`).join(' ') || '<span class="muted">—</span>';
      const evidence = (v.evidence_links ?? []).map(u => `<li><a href="${escapeAttr(u)}" target="_blank" rel="noopener">Evidence</a></li>`).join('') || '<li class="muted">—</li>';

      // Drafts
      const en = it.draft_en ? `<p>${escapeHtml(it.draft_en)}</p>` : '<p class="muted">—</p>';
      const ar = it.draft_ar ? `<p dir="rtl" class="rtl">${escapeHtml(it.draft_ar)}</p>` : '<p class="muted">—</p>';

      card.innerHTML = `
        ${title}
        <div class="grid">
          <div>
            <h4>Drivers</h4>
            <ul class="tight">${drivers}</ul>
          </div>
          <div>
            <h4>Vendors</h4>
            <div class="chips">${vendors}</div>
          </div>
          <div>
            <h4>Evidence</h4>
            <ul class="tight">${evidence}</ul>
          </div>
        </div>
        <details class="blk">
          <summary><strong>Draft (English)</strong></summary>
          ${en}
        </details>
        <details class="blk">
          <summary><strong>Draft (Arabic)</strong></summary>
          ${ar}
        </details>
      `;
      container.appendChild(card);
    });

    $('result').innerHTML = '';
    $('result').appendChild(container);
  }

  function renderFromFileResult(data) {
    if (data.message) { setStatus(data.message); }
    if (data.variance_items && data.variance_items.length) {
      renderResult({ variances: data.variance_items });
      return;
    }
    const ps = (data.procurement_summary && data.procurement_summary.items && data.procurement_summary.items.length)
      ? { items: data.procurement_summary.items, insights: data.insights || data.economic_analysis || {} }
      : (data.summary && data.summary.items && data.summary.items.length)
        ? { items: data.summary.items, insights: data.insights || data.economic_analysis || {} }
        : null;
    if (ps) {
      renderProcurementSummary(ps);
      return;
    }
    const textOnly = (
      data.kind === 'insights' || data.mode === 'insights' ||
      data.summary_text || data.analysis_text || data.insights_text
    );
    if (textOnly) {
      renderSummaryAnalysisInsightsOnly({
        summary_text: data.summary_text || '',
        analysis_text: data.analysis_text || '',
        insights_text: data.insights_text || '',
        model_family: data.model_family || ''
      });
      return;
    }
    if (data.insights) {
      renderInsights(data.insights);
      return;
    }
    $('result').textContent = 'No budget-vs-actual data detected.';
  }

  function renderProcurementSummary({ items, insights }) {
    const box = $('result');
    box.innerHTML = '';
    items.forEach(it => {
      const div = document.createElement('section');
      div.className = 'report__card';
      div.innerHTML = `
        <div class="card__head">
          <div>
            <h3>${escapeHtml(it.item_code || '—')}</h3>
            <div class="muted">Vendor: ${escapeHtml(it.vendor_name || it.vendor || '—')}</div>
          </div>
          <div class="figures">
            <div><span class="label">Qty</span><span class="val">${escapeHtml(it.qty ?? '—')}</span></div>
            <div><span class="label">Unit price</span><span class="val">${escapeHtml(it.unit_price_sar ?? '—')}</span></div>
            <div><span class="label">Amount</span><span class="val">${escapeHtml(it.amount_sar ?? '—')}</span></div>
          </div>
        </div>
        <div class="blk"><p>${escapeHtml(it.description || '')}</p></div>
      `;
      box.appendChild(div);
    });
    // (Raw JSON dump removed to keep UI concise)
  }

  function renderInsights(ins) {
    const box = $('result');
    box.innerHTML = '';
    const highlights = (ins && ins.highlights && ins.highlights.length)
      ? ('<ul>' + ins.highlights.map(x => `<li>${escapeHtml(x)}</li>`).join('') + '</ul>')
      : '<p class="muted">No highlights available.</p>';
    const cards = (ins && ins.cards)
      ? ins.cards.map(c => `<div>${escapeHtml(c.title || c.sheet || 'Metric')}: ${escapeHtml(String(c.value_sar ?? c.value ?? '—'))}</div>`).join('')
      : '';
    const div = document.createElement('section');
    div.className = 'report__card';
    const title = escapeHtml(ins.title || 'Workbook Insights');
    div.innerHTML = `<div class="card__head"><div><h3>${title}</h3></div></div>${highlights}${cards}`;
    box.appendChild(div);
    function appendTable(title, rows, cols) {
      if (!rows || !rows.length) return;
      const table = document.createElement('table');
      const th = cols.map(c => `<th>${escapeHtml(c)}</th>`).join('');
      const trs = rows.slice(0, 20).map(r => `<tr>${cols.map(c => `<td>${escapeHtml(String(r[c] ?? ''))}</td>`).join('')}</tr>`).join('');
      table.innerHTML = `<thead><tr>${th}</tr></thead><tbody>${trs}</tbody>`;
      const wrap = document.createElement('section');
      wrap.className = 'report__card';
      wrap.innerHTML = `<div class="card__head"><div><h3>${escapeHtml(title)}</h3></div></div>`;
      wrap.appendChild(table);
      box.appendChild(wrap);
    }
    appendTable('Top vendors by spend', (ins.tables && ins.tables['workbook::vendor_totals']) || [], ['vendor','total_sar']);
    appendTable('Largest bid spreads', (ins.tables && ins.tables['workbook::vendor_spreads']) || [], ['description','min_vendor','min_unit_sar','max_vendor','max_unit_sar','spread_pct']);
    if (ins.tables) {
      for (const [key, rows] of Object.entries(ins.tables)) {
        if (key === 'workbook::vendor_totals' || key === 'workbook::vendor_spreads') continue;
        const cols = Object.keys(rows[0] || {});
        appendTable(key.replace(/[_:]+/g, ' '), rows, cols);
      }
    }
  }

  function renderSummaryAnalysisInsightsOnly(payload) {
    const box = $('result');
    box.innerHTML = '';
    const { summary_text = '', analysis_text = '', insights_text = '', model_family = '' } = payload || {};
    const srcLabel = model_family === 'chatgpt'
      ? 'Generated via ChatGPT'
      : (model_family === 'local' ? 'Generated locally' : '');
    const sections = []
      .concat(srcLabel ? `<p class="muted">${escapeHtml(srcLabel)}</p>` : [])
      .concat(summary_text ? `<h3>Summary</h3><p>${escapeHtml(summary_text)}</p>` : [])
      .concat(analysis_text ? `<h3>Financial analysis</h3><p>${escapeHtml(analysis_text)}</p>` : [])
      .concat(insights_text ? `<h3>Financial insights</h3><p>${escapeHtml(insights_text)}</p>` : []);
    const wrap = document.createElement('section');
    wrap.className = 'report__card';
    wrap.innerHTML = sections.join('');
    box.appendChild(wrap);
  }

  // helpers used in report
  function fmtNumber(n) {
    const x = Number(n);
    if (!Number.isFinite(x)) return '—';
    return x.toLocaleString(undefined, { maximumFractionDigits: 0 });
  }
  function fmtPct(p) {
    if (p == null || p === '') return '—';
    const x = Number(p);
    if (!Number.isFinite(x)) return '—';
    return x.toFixed(1) + '%';
  }
  function escapeHtml(s) {
    return String(s ?? '')
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#39;");
  }
  function escapeAttr(s){ return escapeHtml(s); }
</script>
</body>
</html>

